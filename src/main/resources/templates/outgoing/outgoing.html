<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <link href="/css/style.css" rel="stylesheet"/>
</head>
<body>
<div layout:fragment="content">
  <div class="col-md-12 p-4">
    <h3>출고 예정 현황</h3>
    <hr>
    <div class="container mt-4">
      <div class="row align-items-center">
        <!-- 날짜 선택 -->
        <div class="col-auto">
          <input type="date" id="start-date" class="form-control">
        </div>
        <div class="col-auto">
          <input type="date" id="end-date" class="form-control">
        </div>

        <!-- 상품명 검색 -->
        <div class="col-auto">
          <input type="text" id="product-name" class="form-control" placeholder="상품명을 입력하세요.">
        </div>
        <div class="col-auto">
          <button id="search-btn" class="btn btn-warning text-white">검색</button>
        </div>

        <!-- 상태 검색 -->
        <div class="col-auto">
          <select id="status" class="form-select">
            <option value="" id="all">전체</option> <!-- 전체를 공백 값으로 처리 -->
            <option value="0">출고 예정</option>
            <option value="1">피킹 중</option>
            <option value="2">출고 완료</option>
            <option value="3">출고 취소</option>
          </select>
        </div>

        <!-- 날짜 정렬 및 초기화 -->
        <div class="col-auto">
          <button id="sort-date-btn" class="btn btn-warning text-white">날짜 정렬</button>
        </div>
        <div class="col-auto">
          <button class="btn btn-warning text-white">초기화</button>
        </div>
      </div>
    </div>
    <label class="form-label d-block">&nbsp;</label>
    <table class="table table-bordered text-center align-middle">
      <thead class="table">
      <tr class="bg-warning text-white">
        <th>#</th>
        <th>
          <input type="checkbox" id="selectAll"> <!-- 마스터 체크박스 -->
        </th>
        <th>지점명</th>
        <th>상품명</th>
        <th>수량</th>
        <th>출고금액</th>
        <th>총금액</th>
        <th>상태</th>
        <th>출고 요청 날짜</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="outgoing : ${outgoingList}">
        <td th:text="${outgoing.outgoingId}"></td>
        <td>
          <input type="checkbox" class="rowCheckbox">
        </td>
        <td th:text="${outgoing.branchName}"></td>
        <td th:text="${outgoing.productName}"></td>
        <td th:text="${outgoing.outgoingQuantity}"></td>
        <td th:text="${outgoing.unitPrice}"></td>
        <td th:text="${outgoing.totalPrice}" data-price="${outgoing.totalPrice}"></td>
        <td th:if="${outgoing.outgoingStatus == 0}">출고 예정</td>
        <td th:if="${outgoing.outgoingStatus == 1}">피킹 중</td>
        <td th:if="${outgoing.outgoingStatus == 2}">출고 완료</td>
        <td th:if="${outgoing.outgoingStatus == 3}">출고 취소</td>
        <td th:text="${outgoing.outgoingDate}"></td>
      </tr>
      </tbody>
    </table>
    <div id="total-bar" class="mt-3 text-end">
      <strong>총 금액: <span id="total-amount">0</span> 원</strong>
    </div>
  </div>
</div>
</body>
</html>

<script>

  document.getElementById('search-btn').addEventListener('click', async () => {
    //시작일과 종료일 가져오기
    const startDate = document.getElementById("start-date").value;
    const endDate = document.getElementById("end-date").value;
    alert(startDate);
    alert(endDate);
    if (!startDate || !endDate) {
      alert("시작일과 종료일 모두 선택해주세요.");
      return;
    }

    if (new Date(startDate) > new Date(endDate)) {
      alert("시작일이 종료일보다 이후일 수 없습니다.")
      return;
    }

    try {
      const response = await fetch(`/outgoing/searchByDate?startDate=${startDate}&endDate=${endDate}`);
      if (response.ok) {
        const data = await response.json();
        updateTable(data);
      } else {
        alert("데이터를 가져오는 데 실패했습니다.");
      }
    } catch (error) {
      console.error("AJAX 요청 중 오류 발생:", error);
    }

  });

  document.getElementById('selectAll').addEventListener('click', function () {
    const isChecked = this.checked; // 마스터 체크박스의 상태 가져오기
    const checkboxes = document.querySelectorAll('.rowCheckbox'); // 모든 행의 체크박스 선택

    checkboxes.forEach(checkbox => {
      if (!checkbox.disabled) { // 체크박스가 비활성화되지 않은 경우에만 동작
        checkbox.checked = isChecked; // 마스터 체크박스 상태에 따라 설정
      }
    });
  });

  // 총 금액 업데이트 함수
  async function updateTotalAsync() {
    const checkboxes = document.querySelectorAll('.rowCheckbox:checked'); // 체크된 체크박스 선택
    let total = 0;
    checkboxes.forEach(checkbox => {
      const row = checkbox.closest('tr'); // 체크박스가 속한 행 가져오기
      console.log(row);
      const priceCell = row.querySelector('td[data-price]'); // 금액 셀 가져오기
      const price = parseInt(priceCell.getAttribute('data-price')); // 금액 가져오기
      total += price; // 총 금액 합산
    });

    // 총 금액을 비동기로 DOM 업데이트
    document.getElementById('total-amount').innerText = total.toLocaleString(); // 천 단위 콤마 추가
  }

  // 체크박스 상태 변경 이벤트 리스너 추가
  document.querySelectorAll('.rowCheckbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateTotalAsync); // 체크박스 상태 변경 시 총 금액 업데이트
  });

  // 마스터 체크박스 상태 변경 이벤트 리스너 추가
  document.getElementById('selectAll').addEventListener('change', function () {
    const isChecked = this.checked; // 마스터 체크박스 상태
    const checkboxes = document.querySelectorAll('.rowCheckbox');

    checkboxes.forEach(checkbox => {
      if (!checkbox.disabled) { // 비활성화된 체크박스 제외
        checkbox.checked = isChecked; // 마스터 체크박스 상태로 설정
      }
    });

    updateTotalAsync(); // 마스터 체크박스 변경 시 총 금액 업데이트
  });

  let isAscending = true; // 초기 정렬 상태 (오름차순)

  // 상품명 검색 기능
  document.getElementById('product-search-btn').addEventListener('click', function () {
    const searchText = document.getElementById('product-name').value.trim().toLowerCase(); // 검색어 가져오기 (소문자로 변환)
    const rows = document.querySelectorAll('tbody tr'); // 테이블의 모든 행 가져오기

    rows.forEach(row => {
      const productNameCell = row.querySelector('td:nth-child(4)'); // 상품명 열 (4번째 열로 가정)
      const productName = productNameCell ? productNameCell.textContent.trim().toLowerCase() : ''; // 상품명 텍스트 가져오기 (소문자로 변환)

      // 검색어와 일치 여부 확인
      if (productName.includes(searchText) || searchText === '') {
        row.style.display = ''; // 검색어와 일치하면 행 표시
      } else {
        row.style.display = 'none'; // 일치하지 않으면 행 숨기기
      }
    });
  });

  document.getElementById('sort-date-btn').addEventListener('click', function () {
    const tbody = document.querySelector('tbody'); // 테이블 본문 가져오기
    const rows = Array.from(tbody.querySelectorAll('tr')); // 모든 행을 배열로 변환

    // 날짜를 기준으로 행 정렬
    rows.sort((a, b) => {
      const dateA = new Date(a.querySelector('td:nth-child(9)').textContent.trim());
      const dateB = new Date(b.querySelector('td:nth-child(9)').textContent.trim());

      // 오름차순/내림차순에 따라 정렬
      return isAscending ? dateA - dateB : dateB - dateA;
    });

    // 정렬된 행을 테이블 본문에 추가
    rows.forEach(row => tbody.appendChild(row));

    // 정렬 상태 반전
    isAscending = !isAscending;
  });
</script>